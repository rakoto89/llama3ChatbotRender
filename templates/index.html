<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Awareness Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Add the Bowie State Logo here -->
    <img src="{{ url_for('static', filename='images/bowie_state_logo.png') }}" alt="Bowie State Logo" class="top-right-image">
    
    <div class="chat-container">
        <div class="chat-header">Opioid Awareness Chatbot</div>
        <div class="chat-box" id="chat-box">
            <div class="bot-message">Welcome to the Opioid Awareness Chatbot! Here you will learn all about opioids!</div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Enter your question..." disabled>
            <button id="send-btn" onclick="sendMessage()">Send</button>
            <button id="voice-btn" onclick="toggleVoiceInput()">Voice</button>
            <button id="stop-btn" onclick="stopVoiceInput()" disabled>Stop</button>
        </div>
    </div>

    <!-- End Chat Button -->
    <button id="end-chat-btn" onclick="endChat()">End Conversation</button>

    <!-- Feedback Modal (Initially Hidden) -->
    <div id="feedback-modal" style="display: none;">
        <h3>Rate the Conversation</h3>
        <div id="stars">
            <span onclick="rateChat(1)">⭐</span>
            <span onclick="rateChat(2)">⭐</span>
            <span onclick="rateChat(3)">⭐</span>
            <span onclick="rateChat(4)">⭐</span>
            <span onclick="rateChat(5)">⭐</span>
        </div>
        <textarea id="review-text" placeholder="Write your review (optional)"></textarea>
        <button onclick="submitFeedback()">Submit Feedback</button>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        let chatEnded = false;
        let isVoiceMode = false;
        let recognition;

        // Function to send a message
        function sendMessage() {
            if (chatEnded) return; // Prevent sending messages after chat ends
            
            let message = document.getElementById("user-input").value;
            document.getElementById("chat-box").innerHTML += "<div class='user-message'>" + message + "</div>";
            document.getElementById("user-input").value = ''; // Clear input field
        }

        // Function to end the chat
        function endChat() {
            chatEnded = true; // Prevent sending messages after chat ends
            document.querySelector(".chat-container").style.display = "none"; // Hide the chat container
            document.getElementById("end-chat-btn").style.display = "none"; // Hide the end button
            
            // Show the feedback modal after ending the conversation
            document.getElementById("feedback-modal").style.display = "block";
        }

        // Function to toggle voice input mode
        function toggleVoiceInput() {
            if (isVoiceMode) {
                stopVoiceInput(); // If already in voice mode, stop it
            } else {
                startVoiceInput(); // Start voice input
            }
        }

        // Start voice input using the Web Speech API
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Speech Recognition is not supported in this browser.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = "en-US";
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function() {
                document.getElementById("stop-btn").disabled = false;
                document.getElementById("user-input").disabled = true; // Disable text input when in voice mode
            };

            recognition.onresult = function(event) {
                let transcript = event.results[event.resultIndex][0].transcript;
                document.getElementById("user-input").value = transcript;
            };

            recognition.onend = function() {
                document.getElementById("stop-btn").disabled = true;
            };

            recognition.start();
            isVoiceMode = true;
        }

        // Stop voice input
        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
            }
            isVoiceMode = false;
            document.getElementById("user-input").disabled = false; // Re-enable text input
            document.getElementById("stop-btn").disabled = true;
        }

        let userRating = 0;

        // Function to rate the chat
        function rateChat(stars) {
            userRating = stars;
            let starElements = document.querySelectorAll("#stars span");
            
            // Update star colors based on rating
            starElements.forEach((star, index) => {
                star.style.color = index < userRating ? "#ffcc00" : "#ccc";
            });
        }

        // Submit feedback
        function submitFeedback() {
            let review = document.getElementById("review-text").value;
            
            // Logic to handle the feedback submission, like sending it to a server or storing it locally
            console.log("Feedback submitted: ");
            console.log("Rating: " + userRating);
            console.log("Review: " + review);
            
            // Hide the feedback modal
            document.getElementById("feedback-modal").style.display = "none";
            alert("Thank you for your feedback!");
        }
    </script>
</body>
</html>
